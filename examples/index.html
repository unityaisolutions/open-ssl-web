<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>WebOpenSSL Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 2rem; line-height: 1.5; }
    .key { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; word-break: break-all; margin-top: 0.5rem; padding: 0.75rem; background: #f7f7f9; border: 1px solid #e6e6e8; border-radius: 8px; }
    .row { margin-bottom: 1rem; }
    button { padding: 0.6rem 1rem; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; }
    button:hover { background: #f0f0f0; }
    .provider { color: #555; }
    label { display: block; margin-top: 0.5rem; }
    input[type="text"], input[type="number"], textarea { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 6px; }
    h2, h3 { margin-top: 2rem; }
    .muted { color: #666; font-size: 0.95rem; }
  </style>
</head>
<body>
  <h1>WebOpenSSL Demo</h1>
  <p class="provider">Provider: <span id="provider"></span></p>

  <div class="row">
    <button id="gen32">Generate base64 key (32 bytes)</button>
    <div id="k32" class="key"></div>
  </div>

  <div class="row">
    <button id="gen64">Generate base64 key (64 bytes)</button>
    <div id="k64" class="key"></div>
  </div>

  <div class="row">
    <button id="genhex32">Generate hex key (32 bytes)</button>
    <div id="khex32" class="key"></div>
  </div>

  <h2>WASM-only functions (OpenSSL)</h2>
  <p id="wasm-note" class="provider">These demos require the OpenSSL WASM provider. It will auto-load if available.</p>

  <!-- Hashing -->
  <div class="row">
    <h3>Hashing (SHA-256 / SHA-512)</h3>
    <label for="hash-input">Input text</label>
    <input id="hash-input" type="text" value="hello">
    <div style="margin-top: 0.5rem;">
      <button id="btn-sha256" disabled>SHA-256</button>
      <div class="key">
        <div>SHA-256 (hex): <span id="sha256-hex"></span></div>
        <div>SHA-256 (base64): <span id="sha256-b64"></span></div>
      </div>
    </div>
    <div style="margin-top: 0.5rem;">
      <button id="btn-sha512" disabled>SHA-512</button>
      <div class="key">
        <div>SHA-512 (hex): <span id="sha512-hex"></span></div>
        <div>SHA-512 (base64): <span id="sha512-b64"></span></div>
      </div>
    </div>
  </div>

  <!-- PBKDF2 -->
  <div class="row">
    <h3>PBKDF2-HMAC (SHA-256 / SHA-512)</h3>
    <label for="pbkdf2-pass">Password</label>
    <input id="pbkdf2-pass" type="text" value="password">
    <label for="pbkdf2-salt">Salt</label>
    <input id="pbkdf2-salt" type="text" value="salt">
    <button id="pbkdf2-random-salt" disabled>Generate random salt (16 bytes)</button>
    <label for="pbkdf2-iter">Iterations</label>
    <input id="pbkdf2-iter" type="number" value="100000" min="1">
    <label for="pbkdf2-keylen">Key length (bytes)</label>
    <input id="pbkdf2-keylen" type="number" value="32" min="1">

    <div style="margin-top: 0.5rem;">
      <button id="pbkdf2-256" disabled>Derive key (SHA-256)</button>
      <div class="key">Hex: <span id="pbkdf2-256-hex"></span><br>Base64: <span id="pbkdf2-256-b64"></span></div>
    </div>
    <div style="margin-top: 0.5rem;">
      <button id="pbkdf2-512" disabled>Derive key (SHA-512)</button>
      <div class="key">Hex: <span id="pbkdf2-512-hex"></span><br>Base64: <span id="pbkdf2-512-b64"></span></div>
    </div>
  </div>

  <!-- AES-256-GCM -->
  <div class="row">
    <h3>AES-256-GCM encrypt/decrypt</h3>
    <p class="muted">Key and IV are generated randomly when the WASM provider loads.</p>
    <div>Key (base64): <span id="aes-key-b64"></span></div>
    <div>IV (base64): <span id="aes-iv-b64"></span></div>

    <label for="aes-aad">AAD (optional)</label>
    <input id="aes-aad" type="text" value="">

    <label for="aes-pt">Plaintext</label>
    <textarea id="aes-pt" rows="3">secret message</textarea>

    <div style="margin-top: 0.5rem;">
      <button id="aes-encrypt" disabled>Encrypt</button>
      <div class="key">Ciphertext (base64): <span id="aes-ct-b64"></span><br>Tag (base64): <span id="aes-tag-b64"></span></div>
    </div>

    <div style="margin-top: 0.5rem;">
      <button id="aes-decrypt" disabled>Decrypt</button>
      <div class="key">Plaintext: <span id="aes-pt-out"></span></div>
    </div>
  </div>

  <script src="../dist/webopenssl.min.js"></script>
  <script>
    function updateProvider() {
      document.getElementById('provider').textContent = WebOpenSSL.getProviderName();
    }
    updateProvider();

    function bytesToHex(bytes) {
      let s = "";
      for (let i = 0; i < bytes.length; i++) {
        let h = bytes[i].toString(16); if (h.length < 2) h = "0" + h; s += h;
      }
      return s;
    }
    function bytesToBase64(bytes) {
      if (typeof Buffer !== "undefined" && typeof Buffer.from === "function") {
        return Buffer.from(bytes).toString("base64");
      }
      let binary = "";
      const chunkSize = 0x8000;
      for (let i = 0; i < bytes.length; i += chunkSize) {
        binary += String.fromCharCode.apply(null, bytes.subarray(i, i + chunkSize));
      }
      return btoa(binary);
    }
    function utf8Bytes(s) {
      return new TextEncoder().encode(s);
    }

    // Try to auto-load the OpenSSL WASM provider if available
    let wasmLoaded = false;
    WebOpenSSL.autoLoadOpenSSLWASM({ url: '../dist/openssl-wasm/openssl_module.js' })
      .then((loaded) => {
        wasmLoaded = loaded;
        if (loaded) {
          document.getElementById('wasm-note').textContent = "OpenSSL WASM loaded.";
          initAes();
        } else {
          document.getElementById('wasm-note').textContent = "OpenSSL WASM not found. WASM-only demos remain disabled.";
        }
        enableWasmDemos(loaded);
        updateProvider();
      });

    function enableWasmDemos(enabled) {
      const ids = [
        'btn-sha256','btn-sha512',
        'pbkdf2-random-salt','pbkdf2-256','pbkdf2-512',
        'aes-encrypt','aes-decrypt'
      ];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = !enabled;
      });
    }

    // Base random demos
    document.getElementById('gen32').addEventListener('click', () => {
      document.getElementById('k32').textContent = WebOpenSSL.randBase64(32);
    });

    document.getElementById('gen64').addEventListener('click', () => {
      document.getElementById('k64').textContent = WebOpenSSL.randBase64(64);
    });

    document.getElementById('genhex32').addEventListener('click', () => {
      document.getElementById('khex32').textContent = WebOpenSSL.randHex(32);
    });

    // Hashing demos
    document.getElementById('btn-sha256').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      const input = document.getElementById('hash-input').value;
      const digest = WebOpenSSL.sha256(utf8Bytes(input));
      document.getElementById('sha256-hex').textContent = bytesToHex(digest);
      document.getElementById('sha256-b64').textContent = bytesToBase64(digest);
    });

    document.getElementById('btn-sha512').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      const input = document.getElementById('hash-input').value;
      const digest = WebOpenSSL.sha512(utf8Bytes(input));
      document.getElementById('sha512-hex').textContent = bytesToHex(digest);
      document.getElementById('sha512-b64').textContent = bytesToBase64(digest);
    });

    // PBKDF2 demos
    let pbkdf2SaltBytes = null;
    document.getElementById('pbkdf2-random-salt').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      pbkdf2SaltBytes = WebOpenSSL.randBytes(16);
      document.getElementById('pbkdf2-salt').value = '(random 16 bytes: ' + bytesToBase64(pbkdf2SaltBytes) + ')';
    });

    function getPbkdf2Params() {
      const pass = document.getElementById('pbkdf2-pass').value;
      const saltStr = document.getElementById('pbkdf2-salt').value;
      const iterations = parseInt(document.getElementById('pbkdf2-iter').value, 10);
      const keyLen = parseInt(document.getElementById('pbkdf2-keylen').value, 10);
      const passBytes = utf8Bytes(pass);
      const saltBytes = pbkdf2SaltBytes || utf8Bytes(saltStr);
      return { passBytes, saltBytes, iterations, keyLen };
    }

    document.getElementById('pbkdf2-256').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      const { passBytes, saltBytes, iterations, keyLen } = getPbkdf2Params();
      const key = WebOpenSSL.pbkdf2HmacSha256(passBytes, saltBytes, iterations, keyLen);
      document.getElementById('pbkdf2-256-hex').textContent = bytesToHex(key);
      document.getElementById('pbkdf2-256-b64').textContent = bytesToBase64(key);
    });

    document.getElementById('pbkdf2-512').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      const { passBytes, saltBytes, iterations, keyLen } = getPbkdf2Params();
      const key = WebOpenSSL.pbkdf2HmacSha512(passBytes, saltBytes, iterations, keyLen);
      document.getElementById('pbkdf2-512-hex').textContent = bytesToHex(key);
      document.getElementById('pbkdf2-512-b64').textContent = bytesToBase64(key);
    });

    // AES-256-GCM demos
    let aesKey = null, aesIv = null, lastCiphertext = null, lastTag = null;

    function initAes() {
      aesKey = WebOpenSSL.randBytes(32);
      aesIv = WebOpenSSL.randBytes(12);
      document.getElementById('aes-key-b64').textContent = bytesToBase64(aesKey);
      document.getElementById('aes-iv-b64').textContent = bytesToBase64(aesIv);
    }

    document.getElementById('aes-encrypt').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      const aad = utf8Bytes(document.getElementById('aes-aad').value);
      const plaintext = utf8Bytes(document.getElementById('aes-pt').value);
      const { ciphertext, tag } = WebOpenSSL.aes256GcmEncrypt(aesKey, aesIv, aad, plaintext);
      lastCiphertext = ciphertext;
      lastTag = tag;
      document.getElementById('aes-ct-b64').textContent = bytesToBase64(ciphertext);
      document.getElementById('aes-tag-b64').textContent = bytesToBase64(tag);
    });

    document.getElementById('aes-decrypt').addEventListener('click', () => {
      if (!wasmLoaded) return alert('OpenSSL WASM provider not loaded.');
      if (!lastCiphertext || !lastTag) return alert('No ciphertext/tag available. Encrypt first.');
      const aad = utf8Bytes(document.getElementById('aes-aad').value);
      const plaintext = WebOpenSSL.aes256GcmDecrypt(aesKey, aesIv, aad, lastCiphertext, lastTag);
      document.getElementById('aes-pt-out').textContent = new TextDecoder().decode(plaintext);
    });
  </script>
</body>
</html>